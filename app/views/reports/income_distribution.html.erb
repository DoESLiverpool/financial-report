<%- chart_uuid = SecureRandom.uuid -%>
<% if !@export %>
<%= form_tag("", method: "get") do %>
<div>
<%= label_tag :bank_account, "Bank account:" %>
<%= select_tag :bank_account, options_for_select( @bank_accounts, params[:bank_account] ) %>
</div>
<div>
<%= label_tag :start_date, "Start date:" %>
<%= text_field_tag :start_date, @start_date, size:12 %>
<%= label_tag :end_date, "End date:" %>
<%= text_field_tag :end_date, @end_date, size:12 %>
</div>
<div>
<%= label_tag :stacked_percent, "Stacked as percent:" %>
<%= check_box_tag :stacked_percent, "on", params[:stacked_percent] =='on' %>
<%= label_tag :exclusions, "Exclude categories:" %>
<%= select_tag :exclusions, options_for_select( ProductCategory.all.map { |c| c.name }, params[:exclusions]), {multiple: true, size: 5} %>
<%= submit_tag "Show" %>
</div>
<div>
<%= label_tag :export, "Export" %>
<%= check_box_tag :export, "on", params[:export] =='on' %>
</div>
<div>
<%= submit_tag "All Time", name: "all_time" %>
</div>
<% end %>

<% end %>

<% if params[:bank_account] %>

<script>
  chartLoaders.push(function() {
    var dataArray = [
      <%= raw ["Categories"].concat(@categories).to_json %>,
      <% if params[:stacked_percent] == 'on' %>
      <%= raw [ "Total" ].concat(@categories.map { |category| Float(@totals[category]["Total"])} ) %>,
      <% end %>
      <% @periods.each do |period| %>
      <%= raw [ period ].concat(@categories.map { |category| Float(@totals[category][period] || 0)}) %>,
      <% end %>
    ];
    var data = google.visualization.arrayToDataTable(dataArray);
    var options = {
      isStacked: <%= raw (params[:stacked_percent] == 'on' ? 'percent' : true).to_json %>
    };
    var chart = new google.visualization.BarChart(document.getElementById('bar_chart-<%=chart_uuid%>'));
    google.visualization.events.addListener(chart, 'ready', function () {
      var link = document.getElementById('bar_chart_link-<%=chart_uuid%>')
      link.href = chart.getImageURI()
      link.style.visibility = "visible"
    });
    chart.draw(data, options);
  })
  <% if !@export %>
  chartLoaders.push(function () {
    var dataArray = [
      ['Description', 'Total'],
    <% @categories.each do |category| %>
      <%= raw [ category, Float(@totals[category]["Total"]) ].to_json %>,
    <% end %>
    ];
    var data = google.visualization.arrayToDataTable(dataArray);
    var options = {
    };
    var chart = new google.visualization.PieChart(document.getElementById('totals_chart-<%=chart_uuid%>'));
    google.visualization.events.addListener(chart, 'ready', function () {
      var link = document.getElementById('totals_chart_link-<%=chart_uuid%>')
      link.href = chart.getImageURI()
      link.style.visibility = "visible"
    });
    chart.draw(data, options);
  })
  <% end %>
</script>
<% if !@export %>
<div id="totals_chart-<%=chart_uuid%>" style="width: 900px; height: 500px"></div>
<a id="totals_chart_link-<%=chart_uuid%>" style="visibility: hidden;" href="">Download Chart</a>
<% end %>
<div id="bar_chart-<%=chart_uuid%>" style="width: 900px; height: 500px"></div>
<a id="bar_chart_link-<%=chart_uuid%>" style="visibility: hidden;" href="">Download Chart</a>

<% end %>
